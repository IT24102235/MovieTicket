<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineApp - Showtimes Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/admin.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-ticket-alt me-2 text-white"></i>
                    <span class="fs-4 fw-bold text-white">CineApp</span>
                </div>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-category">Main</div>
                <ul class="list-unstyled">
                    <li class="sidebar-item">
                        <a href="dashboard.html" class="sidebar-link">
                            <i class="fas fa-tachometer-alt sidebar-icon"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                </ul>
                
                <div class="menu-category">Content Management</div>
                <ul class="list-unstyled">
                    <li class="sidebar-item">
                        <a href="movies.html" class="sidebar-link">
                            <i class="fas fa-film sidebar-icon"></i>
                            <span>Movies</span>
                        </a>
                    </li>
                    <li class="sidebar-item active">
                        <a href="showtimes.html" class="sidebar-link">
                            <i class="fas fa-calendar-alt sidebar-icon"></i>
                            <span>Showtimes</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            <nav class="navbar navbar-expand navbar-light topbar">
                <div class="container-fluid">
                    <!-- Sidebar Toggle -->
                    <button id="sidebarToggle" class="btn btn-icon btn-sm">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- Search Form -->
                    <div class="ms-4 me-auto flex-grow-1">
                        <div class="input-group">
                            <span class="input-group-text border-end-0 bg-white">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" placeholder="Search showtimes...">
                        </div>
                    </div>
                    
                    <ul class="navbar-nav ms-auto">
                        <!-- Settings -->
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-cog"></i>
                            </a>
                        </li>
                        
                        <!-- User Profile -->
                        <li class="nav-item ms-2">
                            <div class="d-flex align-items-center">
                                <div class="d-none d-md-block me-3 text-end">
                                    <div class="fw-medium">Admin User</div>
                                    <div class="small text-muted">Administrator</div>
                                </div>
                                <div class="avatar-sm bg-primary rounded-circle text-white d-flex align-items-center justify-content-center">
                                    <span>AU</span>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <!-- Page Content -->
            <div class="content-page">
                <div class="container-fluid">
                    <!-- Page Header -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                        <div class="mb-3 mb-md-0">
                            <h1 class="h3 fw-bold text-gray-900 mb-1">Showtimes Management</h1>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Showtimes</li>
                                </ol>
                            </nav>
                        </div>
                        <div>
                            <button class="btn btn-primary d-flex align-items-center" id="addShowtimeBtn" data-bs-toggle="modal" data-bs-target="#showtimeModal">
                                <i class="fas fa-plus-circle me-2"></i>
                                <span>Add New Showtime</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Alert Container -->
                    <div id="alertContainer"></div>
                    
                    <!-- Filters Section -->
                    <div class="card shadow mb-4">
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="searchShowtime" placeholder="Search">
                                        <label for="searchShowtime"><i class="fas fa-search me-2"></i>Search Showtimes</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-floating">
                                        <input type="date" class="form-control" id="filterDate">
                                        <label for="filterDate">Date</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100 h-100" id="resetFilters">
                                        <i class="fas fa-redo-alt me-2"></i> Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Showtimes Table -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 fw-bold text-primary">Current Showtimes</h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                    <li><a class="dropdown-item" href="#" id="exportCSV"><i class="fas fa-file-csv me-2"></i>Export to CSV</a></li>
                                    <li><a class="dropdown-item" href="#" id="printShowtimes"><i class="fas fa-print me-2"></i>Print</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="showtimesTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="selectAllShowtimes">
                                                </div>
                                            </th>
                                            <th>Movie</th>
                                            <th>Theater</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Price</th>
                                            <th>Available Seats</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="showtimes-list">
                                        <!-- Showtimes will be loaded dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="loadingState" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading showtimes...</p>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="emptyShowtimeState" class="text-center py-5 d-none">
                                <img src="https://via.placeholder.com/150x150?text=No+Showtimes" alt="No Showtimes" class="mb-3" style="opacity: 0.7;">
                                <h5 class="text-muted">No showtimes found</h5>
                                <p class="text-muted mb-3">Try changing your search criteria or add a new showtime.</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#showtimeModal">
                                    <i class="fas fa-plus-circle me-1"></i> Add New Showtime
                                </button>
                            </div>
                        </div>
                    </div>
            
            <!-- Footer -->
            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6 mb-2 mb-md-0">
                            <span>© 2024 CineApp Admin Dashboard</span>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <a href="#">Privacy Policy</a>
                            <span class="mx-1">·</span>
                            <a href="#">Terms of Use</a>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Add/Edit Showtime Modal -->
    <div class="modal fade" id="showtimeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="showtimeModalTitle">Add New Showtime</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="showtimeForm">
                        <input type="hidden" id="showtimeId">
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="movie" class="form-label">Select Movie <span class="text-danger">*</span></label>
                                <select class="form-select" id="movie" required>
                                    <option value="">-- Select Movie --</option>
                                    <!-- Movies will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="date" class="form-label">Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="date" required>
                            </div>
                            <div class="col-md-6">
                                <label for="time" class="form-label">Time <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="time" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="price" class="form-label">Ticket Price <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="price" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="seats" class="form-label">Available Seats <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="seats" min="1" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveShowtimeBtn">
                        <i class="fas fa-save me-1"></i> Save Showtime
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Showtime Modal -->
    <div class="modal fade" id="viewShowtimeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="viewShowtimeTitle">Showtime Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <img id="viewMoviePoster" src="https://via.placeholder.com/300x450?text=Movie+Poster" alt="Movie Poster" class="img-fluid rounded-3" style="max-height: 200px;">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-2 mb-md-0">
                            <h6 class="text-muted">Movie</h6>
                            <p id="viewMovieTitle" class="fw-medium">Movie Title</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Theater</h6>
                            <p id="viewTheaterName" class="fw-medium">Theater Name</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-2 mb-md-0">
                            <h6 class="text-muted">Date</h6>
                            <p id="viewDate" class="fw-medium">Date</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Time</h6>
                            <p id="viewTime" class="fw-medium">Time</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-2 mb-md-0">
                            <h6 class="text-muted">Ticket Price</h6>
                            <p id="viewPrice" class="fw-medium text-primary">$0.00</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Available Seats</h6>
                            <p id="viewSeats" class="fw-medium">0</p>
                        </div>
                    </div>
                    
                    <div id="viewSpecialInfo" class="mb-3 d-none">
                        <h6 class="text-muted">Special Showtime Details</h6>
                        <div class="p-3 bg-light-warning rounded-3">
                            <p id="viewSpecialDetails" class="mb-0">Special event details here.</p>
                        </div>
                    </div>
                    
                    <input type="hidden" id="deleteShowtimeId">
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editShowtimeFromViewBtn">
                        <i class="fas fa-edit me-1"></i> Edit Showtime
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteShowtimeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <div class="avatar-lg bg-light-danger text-danger mx-auto rounded-circle mb-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <h4 class="text-dark">Are you sure?</h4>
                        <p class="mb-0">Do you really want to delete this showtime for <strong id="deleteShowtimeTitle"></strong>? This action cannot be undone.</p>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> Delete Showtime
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sample data for movies
        const movies = [
            { id: 1, title: "Avengers: Endgame", poster: "https://via.placeholder.com/300x450?text=Avengers" },
            { id: 2, title: "Joker", poster: "https://via.placeholder.com/300x450?text=Joker" },
            { id: 3, title: "The Lion King", poster: "https://via.placeholder.com/300x450?text=Lion+King" },
            { id: 4, title: "Dune", poster: "https://via.placeholder.com/300x450?text=Dune" },
            { id: 5, title: "Oppenheimer", poster: "https://via.placeholder.com/300x450?text=Oppenheimer" }
        ];
        
        // Sample data for theaters
        const theaters = [
            { id: 1, name: "Theater 1", capacity: 150 },
            { id: 2, name: "Theater 2", capacity: 120 },
            { id: 3, name: "IMAX Theater", capacity: 200 },
            { id: 4, name: "VIP Theater", capacity: 80 },
            { id: 5, name: "3D Theater", capacity: 100 }
        ];
        
        // Sample data for showtimes
        let showtimes = [
            { id: 1, movieId: 1, theaterId: 3, date: "2024-06-15", time: "18:30", price: 12.99, availableSeats: 120, isSpecial: false, specialDetails: "" },
            { id: 2, movieId: 2, theaterId: 1, date: "2024-06-15", time: "20:00", price: 9.99, availableSeats: 80, isSpecial: false, specialDetails: "" },
            { id: 3, movieId: 3, theaterId: 2, date: "2024-06-16", time: "15:45", price: 8.99, availableSeats: 100, isSpecial: false, specialDetails: "" },
            { id: 4, movieId: 5, theaterId: 3, date: "2024-06-17", time: "19:30", price: 14.99, availableSeats: 180, isSpecial: false, specialDetails: "" },
            { id: 5, movieId: 4, theaterId: 4, date: "2024-06-18", time: "21:00", price: 16.99, availableSeats: 60, isSpecial: false, specialDetails: "" }
        ];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI components
            initUI();
            
            // Load data
            loadMovies();
            loadTheaters();
            loadShowtimes();
            
            // Set up event listeners
            setupEventListeners();
        });
        
        // Initialize UI components
        function initUI() {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Toggle sidebar
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebarToggle && sidebar && mainContent) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                });
            }
        }
        
        // Load movies into dropdowns
        function loadMovies() {
            const movieDropdown = document.getElementById('movie');
            const filterMovieDropdown = document.getElementById('filterMovie');
            
            if (movieDropdown) {
                // Clear existing options (except the first one)
                while (movieDropdown.options.length > 1) {
                    movieDropdown.options.remove(1);
                }
                
                // Add movie options
                movies.forEach(movie => {
                    const option = new Option(movie.title, movie.id);
                    movieDropdown.add(option);
                });
            }
            
            if (filterMovieDropdown) {
                // Clear existing options (except the first one)
                while (filterMovieDropdown.options.length > 1) {
                    filterMovieDropdown.options.remove(1);
                }
                
                // Add movie options for filter
                movies.forEach(movie => {
                    const option = new Option(movie.title, movie.id);
                    filterMovieDropdown.add(option);
                });
            }
        }
        
        // Load theaters into dropdowns
        function loadTheaters() {
            const theaterDropdown = document.getElementById('theater');
            const filterTheaterDropdown = document.getElementById('filterTheater');
            
            if (theaterDropdown) {
                // Clear existing options (except the first one)
                while (theaterDropdown.options.length > 1) {
                    theaterDropdown.options.remove(1);
                }
                
                // Add theater options
                theaters.forEach(theater => {
                    const option = new Option(`${theater.name} (Capacity: ${theater.capacity})`, theater.id);
                    theaterDropdown.add(option);
                });
            }
            
            if (filterTheaterDropdown) {
                // Clear existing options (except the first one)
                while (filterTheaterDropdown.options.length > 1) {
                    filterTheaterDropdown.options.remove(1);
                }
                
                // Add theater options for filter
                theaters.forEach(theater => {
                    const option = new Option(theater.name, theater.id);
                    filterTheaterDropdown.add(option);
                });
            }
        }
        
        // Load showtimes data and populate the table
        function loadShowtimes() {
            const tableBody = document.getElementById('showtimes-list');
            const emptyState = document.getElementById('emptyShowtimeState');
            const loadingState = document.getElementById('loadingState');
            const table = document.getElementById('showtimesTable');
            
            if (tableBody && emptyState && loadingState) {
                // Simulate AJAX loading delay
                setTimeout(() => {
                    // Hide loading state
                    loadingState.classList.add('d-none');
                    
                    if (showtimes.length === 0) {
                        // Show empty state if no showtimes
                        if (table) table.classList.add('d-none');
                        emptyState.classList.remove('d-none');
                        return;
                    }
                    
                    // Show table and hide empty state
                    if (table) table.classList.remove('d-none');
                    emptyState.classList.add('d-none');
                    
                    // Clear existing rows
                    tableBody.innerHTML = '';
                    
                    // Add showtimes to table
                    showtimes.forEach(showtime => {
                        const row = createShowtimeRow(showtime);
                        tableBody.appendChild(row);
                    });
                    
                    // Set up row event listeners
                    setupRowEventListeners();
                }, 1000); // Simulate network delay
            }
        }
        
        // Create a table row for a showtime
        function createShowtimeRow(showtime) {
            const row = document.createElement('tr');
            row.setAttribute('data-id', showtime.id);
            
            const movie = movies.find(m => m.id == showtime.movieId);
            const theater = theaters.find(t => t.id == showtime.theaterId);
            
            if (!movie || !theater) return row;
            
            // Format date and time
            const formattedDate = new Date(showtime.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
            
            // Create row HTML
            row.innerHTML = `
                <td>
                    <div class="form-check">
                        <input class="form-check-input showtime-checkbox" type="checkbox">
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="movie-poster me-2">
                            <img src="${movie.poster}" alt="${movie.title}" class="rounded" width="40">
                        </div>
                        <div>
                            <h6 class="mb-0">${movie.title}</h6>
                            ${showtime.isSpecial ? '<span class="badge bg-warning text-dark">Special</span>' : ''}
                        </div>
                    </div>
                </td>
                <td>${theater.name}</td>
                <td>${formattedDate}</td>
                <td>${formatTime(showtime.time)}</td>
                <td>$${showtime.price.toFixed(2)}</td>
                <td>
                    <span class="badge ${getBadgeClass(showtime.availableSeats, theater.capacity)}">${showtime.availableSeats}</span>
                </td>
                <td>
                    <div class="d-flex">
                        <button class="btn btn-sm btn-info me-1 view-showtime-btn" data-bs-toggle="tooltip" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary me-1 edit-showtime-btn" data-bs-toggle="tooltip" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-showtime-btn" data-bs-toggle="tooltip" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }
        
        // Format time to AM/PM
        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }
        
        // Get badge class based on available seats percentage
        function getBadgeClass(available, capacity) {
            const percentage = (available / capacity) * 100;
            if (percentage <= 20) return 'bg-danger';
            if (percentage <= 50) return 'bg-warning text-dark';
            return 'bg-success';
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Add new showtime button - already handled by data-bs-target
            
            // Save showtime button
            const saveShowtimeBtn = document.getElementById('saveShowtimeBtn');
            if (saveShowtimeBtn) {
                saveShowtimeBtn.addEventListener('click', saveShowtime);
            }
            
            // Select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllShowtimes');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.showtime-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = selectAllCheckbox.checked;
                    });
                });
            }
            
            // Search functionality
            const searchInput = document.getElementById('searchShowtime');
            if (searchInput) {
                searchInput.addEventListener('input', filterShowtimes);
            }
            
            // Filter functionality
            const filterMovie = document.getElementById('filterMovie');
            const filterTheater = document.getElementById('filterTheater');
            const filterDate = document.getElementById('filterDate');
            
            if (filterMovie) filterMovie.addEventListener('change', filterShowtimes);
            if (filterTheater) filterTheater.addEventListener('change', filterShowtimes);
            if (filterDate) filterDate.addEventListener('change', filterShowtimes);
            
            // Reset filters
            const resetFiltersBtn = document.getElementById('resetFilters');
            if (resetFiltersBtn) {
                resetFiltersBtn.addEventListener('click', function() {
                    if (searchInput) searchInput.value = '';
                    if (filterMovie) filterMovie.value = 'all';
                    if (filterTheater) filterTheater.value = 'all';
                    if (filterDate) filterDate.value = '';
                    filterShowtimes();
                });
            }
            
            // Delete confirmation button
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', deleteShowtime);
            }
            
            // Edit showtime from view modal
            const editShowtimeFromViewBtn = document.getElementById('editShowtimeFromViewBtn');
            if (editShowtimeFromViewBtn) {
                editShowtimeFromViewBtn.addEventListener('click', function() {
                    // Get showtime ID from hidden field
                    const showtimeId = document.getElementById('deleteShowtimeId').value;
                    // Hide view modal
                    const viewShowtimeModal = bootstrap.Modal.getInstance(document.getElementById('viewShowtimeModal'));
                    viewShowtimeModal.hide();
                    // Set up edit modal
                    prepareEditModal(showtimeId);
                    // Show edit modal
                    const showtimeModal = new bootstrap.Modal(document.getElementById('showtimeModal'));
                    showtimeModal.show();
                });
            }
            
            // Export CSV button
            const exportCSVBtn = document.getElementById('exportCSV');
            if (exportCSVBtn) {
                exportCSVBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showAlert('Showtimes exported to CSV successfully.', 'success');
                });
            }
            
            // Print button
            const printShowtimesBtn = document.getElementById('printShowtimes');
            if (printShowtimesBtn) {
                printShowtimesBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.print();
                });
            }
        }
        
        // Set up event listeners for table rows
        function setupRowEventListeners() {
            // View showtime button
            const viewBtns = document.querySelectorAll('.view-showtime-btn');
            viewBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const showtimeId = this.closest('tr').getAttribute('data-id');
                    viewShowtime(showtimeId);
                });
            });
            
            // Edit showtime button
            const editBtns = document.querySelectorAll('.edit-showtime-btn');
            editBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const showtimeId = this.closest('tr').getAttribute('data-id');
                    prepareEditModal(showtimeId);
                });
            });
            
            // Delete showtime button
            const deleteBtns = document.querySelectorAll('.delete-showtime-btn');
            deleteBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const showtimeId = this.closest('tr').getAttribute('data-id');
                    prepareDeleteModal(showtimeId);
                });
            });
        }
        
        // Filter showtimes based on search and filter criteria
        function filterShowtimes() {
            const searchValue = document.getElementById('searchShowtime')?.value.toLowerCase() || '';
            const movieFilter = document.getElementById('filterMovie')?.value || 'all';
            const theaterFilter = document.getElementById('filterTheater')?.value || 'all';
            const dateFilter = document.getElementById('filterDate')?.value || '';
            
            const rows = document.querySelectorAll('#showtimes-list tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const showtimeId = row.getAttribute('data-id');
                const showtime = showtimes.find(s => s.id == showtimeId);
                
                if (!showtime) return;
                
                const movie = movies.find(m => m.id == showtime.movieId);
                const theater = theaters.find(t => t.id == showtime.theaterId);
                
                if (!movie || !theater) return;
                
                let matchesSearch = true;
                let matchesMovie = true;
                let matchesTheater = true;
                let matchesDate = true;
                
                // Check search
                if (searchValue !== '') {
                    matchesSearch = movie.title.toLowerCase().includes(searchValue) || 
                                   theater.name.toLowerCase().includes(searchValue);
                }
                
                // Check movie filter
                if (movieFilter !== 'all') {
                    matchesMovie = showtime.movieId == movieFilter;
                }
                
                // Check theater filter
                if (theaterFilter !== 'all') {
                    matchesTheater = showtime.theaterId == theaterFilter;
                }
                
                // Check date filter
                if (dateFilter !== '') {
                    matchesDate = showtime.date === dateFilter;
                }
                
                // Show/hide row based on combined filters
                if (matchesSearch && matchesMovie && matchesTheater && matchesDate) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show/hide empty state
            const emptyState = document.getElementById('emptyShowtimeState');
            const table = document.getElementById('showtimesTable');
            
            if (visibleCount === 0) {
                if (table) table.classList.add('d-none');
                if (emptyState) emptyState.classList.remove('d-none');
            } else {
                if (table) table.classList.remove('d-none');
                if (emptyState) emptyState.classList.add('d-none');
            }
        }
        
        // View showtime details
        function viewShowtime(showtimeId) {
            const showtime = showtimes.find(s => s.id == showtimeId);
            
            if (showtime) {
                const movie = movies.find(m => m.id == showtime.movieId);
                const theater = theaters.find(t => t.id == showtime.theaterId);
                
                // Format date
                const formattedDate = new Date(showtime.date).toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Populate showtime details in view modal
                document.getElementById('viewMoviePoster').src = movie.poster;
                document.getElementById('viewMovieTitle').textContent = movie.title;
                document.getElementById('viewTheaterName').textContent = theater.name;
                document.getElementById('viewDate').textContent = formattedDate;
                document.getElementById('viewTime').textContent = formatTime(showtime.time);
                document.getElementById('viewPrice').textContent = `$${showtime.price.toFixed(2)}`;
                document.getElementById('viewSeats').textContent = showtime.availableSeats;
                
                // Handle special showtime details
                const specialInfoDiv = document.getElementById('viewSpecialInfo');
                if (showtime.isSpecial && showtime.specialDetails) {
                    document.getElementById('viewSpecialDetails').textContent = showtime.specialDetails;
                    specialInfoDiv.classList.remove('d-none');
                } else {
                    specialInfoDiv.classList.add('d-none');
                }
                
                // Set showtime ID for edit/delete actions
                document.getElementById('deleteShowtimeId').value = showtimeId;
                
                // Show modal
                const viewModal = new bootstrap.Modal(document.getElementById('viewShowtimeModal'));
                viewModal.show();
            }
        }
        
        // Prepare edit modal with showtime data
        function prepareEditModal(showtimeId) {
            const showtime = showtimes.find(s => s.id == showtimeId);
            
            if (showtime) {
                // Set form values
                document.getElementById('showtimeId').value = showtime.id;
                document.getElementById('movie').value = showtime.movieId;
                document.getElementById('theater').value = showtime.theaterId;
                document.getElementById('date').value = showtime.date;
                document.getElementById('time').value = showtime.time;
                document.getElementById('price').value = showtime.price;
                document.getElementById('seats').value = showtime.availableSeats;
                
                // Set modal title
                document.getElementById('showtimeModalTitle').textContent = 'Edit Showtime';
                
                // Show modal
                const showtimeModal = new bootstrap.Modal(document.getElementById('showtimeModal'));
                showtimeModal.show();
            }
        }
        
        // Prepare delete confirmation modal
        function prepareDeleteModal(showtimeId) {
            const showtime = showtimes.find(s => s.id == showtimeId);
            
            if (showtime) {
                const movie = movies.find(m => m.id == showtime.movieId);
                
                document.getElementById('deleteShowtimeTitle').textContent = movie ? movie.title : 'this movie';
                document.getElementById('deleteShowtimeId').value = showtimeId;
                
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteShowtimeModal'));
                deleteModal.show();
            }
        }
        
        // Reset showtime form for adding new item
        function resetShowtimeForm() {
            document.getElementById('showtimeForm').reset();
            document.getElementById('showtimeId').value = '';
            document.getElementById('showtimeModalTitle').textContent = 'Add New Showtime';
        }
        
        // Save showtime (add new or update existing)
        function saveShowtime() {
            // Get form values
            const showtimeId = document.getElementById('showtimeId').value;
            const movieId = parseInt(document.getElementById('movie').value);
            const theaterId = parseInt(document.getElementById('theater').value);
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const price = parseFloat(document.getElementById('price').value);
            const availableSeats = parseInt(document.getElementById('seats').value);
            
            // Validate form
            if (!movieId || !theaterId || !date || !time || !price || !availableSeats) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            // Create showtime object
            const showtimeData = {
                movieId,
                theaterId,
                date,
                time,
                price,
                availableSeats
            };
            
            // Simulate loading state
            const saveButton = document.getElementById('saveShowtimeBtn');
            const originalText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Saving...';
            
            setTimeout(() => {
                if (showtimeId) {
                    // Update existing showtime
                    updateShowtime(showtimeId, showtimeData);
                } else {
                    // Add new showtime
                    addShowtime(showtimeData);
                }
                
                // Hide modal
                const showtimeModal = bootstrap.Modal.getInstance(document.getElementById('showtimeModal'));
                showtimeModal.hide();
                
                // Reset form for next use
                resetShowtimeForm();
                
                // Reset button state
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
            }, 1000);
        }
        
        // Add new showtime
        function addShowtime(showtimeData) {
            // In a real app, this would be an AJAX call to the server
            
            // Generate new ID
            const newId = Math.max(...showtimes.map(s => s.id), 0) + 1;
            
            // Add ID to showtime data
            showtimeData.id = newId;
            
            // Add to showtimes array
            showtimes.push(showtimeData);
            
            // Reload showtimes table
            loadShowtimes();
            
            // Show success message
            const movie = movies.find(m => m.id == showtimeData.movieId);
            showAlert(`Showtime for "${movie.title}" has been added successfully.`, 'success');
        }
        
        // Update existing showtime
        function updateShowtime(showtimeId, showtimeData) {
            // In a real app, this would be an AJAX call to the server
            
            const index = showtimes.findIndex(s => s.id == showtimeId);
            
            if (index !== -1) {
                // Keep the ID
                showtimeData.id = parseInt(showtimeId);
                
                // Update the showtime
                showtimes[index] = showtimeData;
                
                // Reload showtimes table
                loadShowtimes();
                
                // Show success message
                const movie = movies.find(m => m.id == showtimeData.movieId);
                showAlert(`Showtime for "${movie.title}" has been updated successfully.`, 'success');
            }
        }
        
        // Delete showtime
        function deleteShowtime() {
            const showtimeId = document.getElementById('deleteShowtimeId').value;
            
            if (showtimeId) {
                const index = showtimes.findIndex(s => s.id == showtimeId);
                
                if (index !== -1) {
                    const showtime = showtimes[index];
                    const movie = movies.find(m => m.id == showtime.movieId);
                    const movieTitle = movie ? movie.title : 'Unknown Movie';
                    
                    // Remove the showtime
                    showtimes.splice(index, 1);
                    
                    // Reload showtimes table
                    loadShowtimes();
                    
                    // Hide modal
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteShowtimeModal'));
                    deleteModal.hide();
                    
                    // Show success message
                    showAlert(`Showtime for "${movieTitle}" has been deleted successfully.`, 'success');
                }
            }
        }
        
        // Show alert message
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            
            if (alertContainer) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible fade show`;
                alert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                alertContainer.appendChild(alert);
                
                // Auto close after 5 seconds
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => {
                        alertContainer.removeChild(alert);
                    }, 300);
                }, 5000);
            }
        }
        
        // Initialize the page when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Add showtime button - reset form when clicked
            const addShowtimeBtn = document.getElementById('addShowtimeBtn');
            if (addShowtimeBtn) {
                addShowtimeBtn.addEventListener('click', resetShowtimeForm);
            }
        });
    </script>
</body>
</html>
